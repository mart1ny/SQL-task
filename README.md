# Online Store Analytics

Учебный проект: аналитическая БД интернет-магазина с полным циклом — структура, данные, отчётные запросы, хранимая процедура и пользовательская функция. Репозиторий готов к быстрому развёртыванию в MySQL 8+.

## Содержимое
| Файл | Назначение |
| --- | --- |
| `schema.sql` | Создаёт схему `online_store_analytics`: пользователи, категории, товары, заказы, позиции заказов, отзывы, таблица `monthly_reports`. |
| `data.sql` | Наполняет таблицы данными 2022–2025 гг., включая свежие заказы и отчёты за 2025 год. |
| `analytics.sql` | 10 аналитических запросов, процедура `generate_monthly_report`, функция `calculate_user_rank`. |
| `REPORT.md` | Текст выступления/презентации о проекте. |

## Связи таблиц
```
users ──< orders ──< order_items >── products >── categories
   \                          \
    \                          └── reviews >── products
     \_______________________________________________/
                    monthly_reports (агрегаты по месяцам)
```
- `users` ↔ `orders`: один пользователь может иметь много заказов.
- `orders` ↔ `order_items`: каждый заказ состоит из нескольких позиций.
- `order_items` ↔ `products`: позиция ссылается на конкретный товар, товар привязан к категории.
- `reviews` связывает пользователей и товары (уникальный отзыв на пару `user_id + product_id`).
- `monthly_reports` заполняется процедурой на основе таблиц `orders` и `users`.

## Быстрый старт
```bash
# 1. Пересоздать БД
mysql -u root -p -e "DROP DATABASE IF EXISTS online_store_analytics; \
  CREATE DATABASE online_store_analytics CHARACTER SET utf8mb4;"

# 2. Структура + данные + аналитика
mysql -u root -p online_store_analytics < schema.sql
mysql -u root -p online_store_analytics < data.sql
mysql -u root -p online_store_analytics < analytics.sql
```

После импорта можно проверить:
```sql
SHOW TABLES;
SELECT COUNT(*) FROM orders; -- 32 заказа
```

## Аналитические запросы
`analytics.sql` включает:
1. Топ‑5 популярных товаров (CTE + оконная функция `DENSE_RANK`).
2. Лидеры среди покупателей за последний месяц.
3. Средний чек по месяцам за год.
4. Пары товаров, которые покупают вместе (self join `order_items`).
5. Воронка статусов заказов с долями.
6. Рейтинг категорий по выручке.
7. Клиенты без заказов ≥30 дней.
8. Сезонность продаж по номеру месяца.
9. Рейтинг городов (оконная функция `RANK`).
10. Сравнение текущего и предыдущего месяцев по ключевым метрикам.

Проект рассчитан на демонстрацию оконных функций, CTE, агрегатов и датовых фильтров `CURDATE()`.

## Хранимая процедура
```sql
CALL generate_monthly_report('2025-12-01');
```
Процедура автоматически собирает метрики месяца, обновляет `monthly_reports` (через `ON DUPLICATE KEY UPDATE`) и возвращает готовый отчёт.

## Пользовательская функция
```sql
SELECT calculate_user_rank(21);
```
Функция оценивает активность пользователя (заказы, траты, отзывы, возраст аккаунта) и присваивает ранг 1–10 для сегментации клиентов.

## Демонстрация в GUI
В TablePlus/Workbench:
1. Подключитесь к `online_store_analytics`.
2. Выполните `analytics.sql` целиком (`Run All`) — результаты появятся в 10 вкладках.
3. Запустите процедуру и функцию отдельными запросами, чтобы показать метрики и ранги.
4. Используйте `REPORT.md` как сценарий выступления.

## Проверка
Перед сдачей/презентацией:
```sql
SHOW TABLES;
SELECT COUNT(*) FROM users;
CALL generate_monthly_report('2025-12-01');
SELECT calculate_user_rank(21);
```
Убедитесь, что все команды выполняются без ошибок и возвращают данные.

